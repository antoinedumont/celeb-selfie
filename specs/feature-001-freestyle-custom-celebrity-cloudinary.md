# Feature: Freestyle-Only Custom Celebrity Input with Cloudinary Storage

## Feature Description
Transform the Celeb Selfie application to focus exclusively on freestyle mode with a streamlined user experience. Users will input any celebrity name with optional context (e.g., "Taylor Swift at concert", "Elon Musk in space") and generate AI-powered selfies using the best prompt automatically generated by Gemini. All generated images will be uploaded to Cloudinary for permanent cloud storage and displayed with shareable URLs.

This feature removes the celebrity grid selection UI and replaces it with a simple text input for maximum flexibility and ease of use. It brings best practices from the booth-selfie codebase, including Cloudinary integration for persistent storage, improved prompt generation, and streamlined UX.

## User Story
As a user
I want to enter any celebrity name with context and instantly generate a realistic selfie
So that I can create personalized AI photos with any celebrity in any setting without being limited to a predefined list

## Problem Statement
The current application requires users to choose from a predefined list of celebrities, limiting flexibility and requiring manual maintenance of celebrity images. Generated photos are stored only in localStorage, which has limited capacity and can be cleared. Users want the ability to specify any celebrity and any context, with permanent cloud storage for their creations.

## Solution Statement
Implement a freestyle-only mode with a text input field that accepts celebrity name + context (e.g., "Brad Pitt at the Oscars", "Serena Williams playing tennis"). The system will use Gemini 3 AI to automatically generate the best possible prompt based on the input, create photorealistic selfies via Nano Banana Pro, upload results to Cloudinary for permanent storage, and display shareable URLs. This provides unlimited celebrity options, context-aware generation, and reliable cloud storage.

## Relevant Files
Use these files to implement the feature:

### Core Application Files
- **src/App.tsx** - Main application component that orchestrates the user flow. Needs to be simplified to remove celebrity grid selection and add text input for custom celebrity + context. Already uses freestyle mode exclusively.

- **src/components/CelebritySelector.tsx** - Current component with celebrity grid. Needs to be replaced or heavily refactored to show only a text input field for celebrity name + context with helpful examples and tips.

- **src/components/CelebrityResult.tsx** - Displays generated results. Needs to be updated to show Cloudinary URLs and provide sharing options.

### AI Services
- **src/services/gemini3PromptGenerator.service.ts** - Generates AI-powered prompts using Gemini 2.5 Flash. Already supports custom celebrity names with context. May need enhancements to parse celebrity name + context from a single input string.

- **src/services/composite/replicateNanoBanana.service.ts** - Handles image generation via Replicate API. Already supports freestyle mode. No changes needed unless we want to enhance metadata.

- **src/services/composite/promptBuilder.ts** - Builds prompts for different modes. Already supports freestyle prompts with Gemini integration. May need minor updates for better context parsing.

### Storage Services
- **src/services/galleryStorage.service.ts** - Current localStorage-based storage. Needs to be enhanced to also upload to Cloudinary and store cloud URLs.

- **src/utils/image.utils.ts** - Image processing utilities including compression. Will be used for optimizing images before Cloudinary upload.

### Configuration
- **src/constants/celebrities.ts** - Currently defines celebrity list. Can be removed or kept for example suggestions only.

- **src/types/index.ts** - TypeScript type definitions. Needs new types for Cloudinary upload results and custom celebrity input.

- **.env** - Environment variables. Needs Cloudinary configuration added (VITE_CLOUDINARY_CLOUD_NAME, VITE_CLOUDINARY_UPLOAD_PRESET).

### New Files
- **src/services/cloudinary.service.ts** - New service for uploading images to Cloudinary, managing uploads, and generating shareable URLs. Will be adapted from booth-selfie's implementation.

- **src/components/CustomCelebrityInput.tsx** - New component for celebrity name + context input with helpful UI, validation, and example suggestions.

- **src/types/cloudinary.types.ts** - TypeScript types for Cloudinary upload results, configuration, and API responses.

## Implementation Plan

### Phase 1: Foundation
1. **Set up Cloudinary integration** - Add Cloudinary environment variables to `.env`, create cloudinary.service.ts with upload, compression, and URL generation functions adapted from booth-selfie.

2. **Create TypeScript types** - Define types for CloudinaryUploadResult, CustomCelebrityInput, and enhanced GalleryMetadata in cloudinary.types.ts.

3. **Install dependencies** - Add any missing dependencies (cloudinary SDK is not needed for browser uploads, but verify no additional packages are required).

### Phase 2: Core Implementation
1. **Build CustomCelebrityInput component** - Create new input component with:
   - Single text input for "Celebrity name + context"
   - Placeholder examples: "Taylor Swift at concert", "Elon Musk in space"
   - Character validation (min 3 characters)
   - Tips section explaining context usage
   - Visual design matching PhotoAI aesthetic

2. **Enhance Gemini prompt generator** - Update gemini3PromptGenerator.service.ts to:
   - Parse celebrity name + context from single string input
   - Extract context keywords (e.g., "at concert", "in space")
   - Use context to inform setting, props, and environment details
   - Improve prompt quality with contextual awareness

3. **Implement Cloudinary upload flow** - Update galleryStorage.service.ts to:
   - Upload generated images to Cloudinary after successful generation
   - Store both data URL (fallback) and Cloudinary URL
   - Handle upload failures gracefully
   - Compress images before upload to prevent 413 errors
   - Add metadata tags for organization

4. **Refactor App.tsx** - Simplify main app to:
   - Remove celebrity grid selection step
   - Add CustomCelebrityInput component after camera capture
   - Auto-generate with freestyle mode always
   - Pass custom celebrity name + context to generation service
   - Handle Cloudinary upload after generation completes

5. **Update CelebrityResult component** - Enhance result display to:
   - Show Cloudinary URL if upload succeeded
   - Provide shareable link with copy button
   - Show fallback data URL if Cloudinary failed
   - Add "Share" button for social media (optional)
   - Display generation metadata (prompt used, processing time)

### Phase 3: Integration
1. **Remove celebrity grid dependencies** - Clean up:
   - Remove CELEBRITIES constant usage from App.tsx
   - Keep celebrities.ts file for optional example suggestions
   - Remove celebrity image files from public/celebrities (or keep for examples)
   - Update CelebritySelector to only show custom input

2. **Test end-to-end flow** - Verify:
   - Camera capture ‚Üí Custom input ‚Üí Generation ‚Üí Cloudinary upload ‚Üí Result display
   - Error handling at each step
   - Fallback to localStorage if Cloudinary fails
   - Prompt quality with various celebrity + context combinations

3. **Update admin gallery** - Enhance AdminGallery component to:
   - Display Cloudinary URLs for cloud-stored images
   - Show both local and cloud-stored photos
   - Add filter for cloud vs local storage
   - Provide bulk export from Cloudinary (optional)

## Step by Step Tasks
IMPORTANT: Execute every step in order, top to bottom.

### Step 1: Environment Setup and Cloudinary Service
- Add Cloudinary environment variables to `.env` file:
  - `VITE_CLOUDINARY_CLOUD_NAME=dy72sfzo2`
  - `VITE_CLOUDINARY_UPLOAD_PRESET=booth_selfie_preset`
- Create `src/types/cloudinary.types.ts` with TypeScript interfaces for CloudinaryUploadResult, CloudinaryConfig
- Create `src/services/cloudinary.service.ts` adapted from booth-selfie with functions:
  - `uploadToCloudinary(dataUrl, filename)` - Upload image to Cloudinary
  - `generateShareableUrl(publicId, options)` - Generate optimized URLs
  - `getPublicIdFromUrl(url)` - Extract public ID from URL
- Test Cloudinary upload with a sample data URL using console logs

### Step 2: Create Custom Celebrity Input Component
- Create `src/components/CustomCelebrityInput.tsx` with:
  - Single text input field for celebrity name + context
  - Placeholder: "e.g. Taylor Swift at concert, Elon Musk in space..."
  - Min 3 characters validation with error message
  - Tips section with bullet points explaining how to use context
  - "Generate ‚ú®" button that calls onSubmit callback
  - Glass morphism styling matching app aesthetic
- Add prop types: `onSubmit(celebrityNameWithContext: string)`, `disabled`, `isLoading`
- Test component in isolation with console logs

### Step 3: Enhance Gemini Prompt Generator for Context Parsing
- Update `src/services/gemini3PromptGenerator.service.ts`:
  - Enhance `generateCelebrityPromptWithGemini3` to better parse celebrity name + context
  - Update meta-prompt to explicitly use context information for setting and environment
  - Improve template filling to incorporate context keywords
  - Add logging for parsed celebrity vs context
- Test prompt generation with various inputs:
  - "Taylor Swift at concert"
  - "Elon Musk in SpaceX factory"
  - "Serena Williams playing tennis"

### Step 4: Update Gallery Storage Service with Cloudinary Integration
- Update `src/services/galleryStorage.service.ts`:
  - Import uploadToCloudinary from cloudinary.service
  - Modify savePhoto function to upload to Cloudinary after saving locally
  - Store both data URL and Cloudinary URL in metadata
  - Handle upload failures gracefully with fallback
  - Add cloudinaryUrl field to GalleryMetadata type
- Update `src/types/gallery.types.ts` to include optional cloudinaryUrl in GalleryMetadata
- Test with mock data to verify dual storage

### Step 5: Refactor App.tsx to Use Custom Input
- Update `src/App.tsx`:
  - Remove celebrity grid selection UI (keep celebrity selection step but change content)
  - Replace CelebritySelector with CustomCelebrityInput component
  - Update handleSelectAndGenerateCelebrity to accept string instead of Celebrity object
  - Parse custom input to extract celebrity name (treat entire input as celebrity name + context)
  - Ensure freestyle mode is always used (already implemented)
  - Add loading state for Cloudinary upload after generation
- Remove CELEBRITIES import if no longer needed
- Test camera ‚Üí custom input ‚Üí generation flow

### Step 6: Update CelebrityResult Component
- Update `src/components/CelebrityResult.tsx`:
  - Add Cloudinary URL display if available
  - Add "Copy Link" button to copy Cloudinary URL to clipboard
  - Show fallback message if Cloudinary upload failed
  - Display storage location badge (Cloud ‚òÅÔ∏è or Local üíæ)
  - Keep existing download button for data URL
- Add props for cloudinaryUrl optional parameter
- Test with both cloud and local URLs

### Step 7: Update Admin Gallery for Cloud Storage
- Update `src/components/admin/AdminGallery.tsx`:
  - Display Cloudinary URLs when available
  - Add badge/icon to distinguish cloud vs local storage
  - Add filter toggle to show "All", "Cloud Only", "Local Only"
  - Show shareable link with copy button for cloud photos
  - Update export functionality to handle cloud URLs
- Test gallery with mix of cloud and local photos

### Step 8: Clean Up Celebrity Grid Dependencies
- Update `src/components/CelebritySelector.tsx`:
  - Remove celebrity grid rendering code
  - Remove file upload functionality (guest image)
  - Keep only custom celebrity modal as primary interface
  - Simplify component to be a wrapper around CustomCelebrityInput
- Optionally keep `src/constants/celebrities.ts` for example suggestions in UI
- Remove unused props and handlers

### Step 9: Integration Testing and Polish
- Test complete end-to-end flow:
  1. Take selfie with camera
  2. Enter custom celebrity + context
  3. Generate with AI prompt
  4. Verify Cloudinary upload
  5. View result with shareable link
  6. Check admin gallery
- Test error scenarios:
  - Invalid celebrity input (too short)
  - Cloudinary upload failure
  - Gemini API failure
  - Network errors
- Verify fallbacks work correctly
- Test on mobile and desktop

### Step 10: Run Validation Commands
- Execute all validation commands to ensure zero regressions
- Verify TypeScript compilation
- Test production build
- Manually test critical user flows

## Testing Strategy

### Unit Tests
- **CustomCelebrityInput component**:
  - Validates minimum character length (3+)
  - Shows error message for invalid input
  - Calls onSubmit with trimmed input
  - Disables button when loading or input invalid

- **cloudinary.service.ts**:
  - uploadToCloudinary returns success with valid data URL
  - uploadToCloudinary handles missing config gracefully
  - generateShareableUrl creates correct URL format
  - Image compression reduces size before upload

- **gemini3PromptGenerator.service.ts**:
  - Parses celebrity name + context correctly
  - Uses context to inform prompt generation
  - Falls back to static prompt if Gemini fails
  - Caches generated prompts to reduce API calls

- **galleryStorage.service.ts**:
  - Saves to localStorage first, then uploads to Cloudinary
  - Stores Cloudinary URL in metadata
  - Falls back gracefully if Cloudinary upload fails
  - Maintains data integrity with dual storage

### Edge Cases
- **Empty or whitespace-only input** - Should show validation error
- **Very long input (500+ characters)** - Should handle or truncate gracefully
- **Special characters in celebrity name** - Should parse correctly
- **Cloudinary upload failure** - Should fall back to localStorage with message
- **No context provided** - Should still generate with celebrity name only
- **Gemini API timeout** - Should fall back to static template
- **Multiple rapid submissions** - Should prevent duplicate requests
- **Browser without localStorage** - Should still work with Cloudinary only
- **Network offline during upload** - Should queue or notify user
- **Very large generated images** - Should compress before Cloudinary upload

## Acceptance Criteria
- ‚úÖ User can capture selfie with camera (existing feature)
- ‚úÖ After capture, user sees custom celebrity input field instead of grid
- ‚úÖ Input field validates minimum 3 characters and shows error if invalid
- ‚úÖ User can enter any celebrity name with optional context (e.g. "Taylor Swift at concert")
- ‚úÖ Clicking "Generate" triggers freestyle mode AI generation with Gemini-powered prompts
- ‚úÖ Gemini prompt generator parses celebrity + context and creates contextual prompts
- ‚úÖ Generated image is automatically uploaded to Cloudinary after generation completes
- ‚úÖ Result page shows Cloudinary URL with "Copy Link" button if upload succeeded
- ‚úÖ Result page shows local storage fallback message if Cloudinary fails
- ‚úÖ Admin gallery displays cloud storage badge for Cloudinary-stored images
- ‚úÖ Admin gallery allows filtering by storage type (cloud/local)
- ‚úÖ All errors are handled gracefully with user-friendly messages
- ‚úÖ Application works on mobile and desktop browsers
- ‚úÖ No references to celebrity grid remain in UI (unless as optional examples)
- ‚úÖ TypeScript compilation succeeds with no errors
- ‚úÖ Production build completes successfully

## Validation Commands
Execute every command to validate the feature works correctly with zero regressions.

```bash
# Install any missing dependencies (none expected, but verify)
cd /Users/antoine/claude/celeb-selfie
npm install

# TypeScript type checking - must pass with zero errors
npm run lint

# Build production bundle - must succeed
npm run build

# Start dev server for manual testing
npm run dev

# Manual validation steps (to be performed in browser):
# 1. Open http://localhost:5174
# 2. Grant camera permissions
# 3. Take a selfie
# 4. Verify custom input field appears (not celebrity grid)
# 5. Enter "Taylor Swift at concert" and click Generate
# 6. Wait for generation (60-90 seconds)
# 7. Verify result shows with Cloudinary URL
# 8. Click "Copy Link" and verify URL copies to clipboard
# 9. Open admin gallery (Ctrl+Shift+G)
# 10. Verify photo appears with cloud storage badge
# 11. Test error case: Enter "ab" (too short) and verify error
# 12. Test fallback: Disconnect network and generate, verify local storage fallback
```

### Additional Manual Testing Checklist
- Test with various celebrity + context combinations:
  - "Elon Musk in SpaceX factory"
  - "Serena Williams playing tennis"
  - "Gordon Ramsay in kitchen"
  - "Barack Obama at White House"
- Verify Gemini generates appropriate settings for each context
- Test Cloudinary upload with multiple images in succession
- Verify shareable URLs work when opened in new browser window
- Test on mobile device (portrait mode, touch input)
- Verify admin gallery filters work (All, Cloud, Local)
- Test edge cases: very long input, special characters, emoji
- Verify graceful degradation if Cloudinary config missing

## Notes

### Best Practices Adopted from booth-selfie
1. **Cloudinary Integration Pattern** - Using browser-based upload with upload presets (no API secret needed client-side), compression before upload, metadata tagging, and graceful fallback to localStorage
2. **Dual Storage Strategy** - Save locally first for instant access, then upload to cloud for persistence and sharing
3. **Error Handling** - Categorized error messages by status code (400, 413, 429, 503) with user-friendly messages
4. **Image Compression** - Always compress before Cloudinary upload to prevent 413 errors and reduce costs
5. **Logging Convention** - Use `[Service/Component]` prefix for all console logs for easy debugging
6. **Type Safety** - Strict TypeScript types for all API responses and service interfaces

### Cloudinary Configuration
- **Cloud Name**: dy72sfzo2 (from booth-selfie .env)
- **Upload Preset**: booth_selfie_preset (unsigned preset, no API secret needed)
- **Auto-deletion**: Configure in Cloudinary dashboard for 30-day expiration (optional)
- **Transformations**: Use quality and format parameters to optimize URLs
- **Folder Structure**: Store in `celeb-selfie/` folder with timestamp-based filenames

### Future Enhancements
- Add celebrity suggestion autocomplete based on popular searches
- Implement social media sharing (Twitter, LinkedIn, Instagram)
- Add QR code generation for mobile sharing (like booth-selfie)
- Store generation history with user accounts (requires backend)
- Add "Trending" or "Popular" celebrity suggestions
- Implement rate limiting for API protection
- Add analytics for most-used celebrities and contexts
- Support multiple language inputs for international celebrities
- Add image-to-image mode where user can upload celebrity photo
- Implement batch generation (multiple contexts with same celebrity)

### Cost Considerations
- **Gemini 2.5 Flash**: ~$0.001-0.005 per prompt (cached for 7 days)
- **Nano Banana Pro**: $0.15 per image generation
- **Cloudinary Free Tier**: 25 GB storage, 25 GB bandwidth/month, unlimited transformations
- **Estimated cost per selfie**: ~$0.15 (prompts cached, Cloudinary within free tier)

### Security Considerations
- API keys exposed in .env are for development only
- For production, use environment variables in hosting platform (Vercel, Netlify)
- Cloudinary upload preset should be "unsigned" and restrict to specific formats/sizes
- Consider adding CAPTCHA for abuse prevention
- Rate limit Cloudinary uploads per IP to prevent abuse
- Validate and sanitize all user inputs before passing to AI services

### Accessibility Considerations
- Input field must have proper ARIA labels
- Validation errors announced to screen readers
- Keyboard navigation support (Tab, Enter to submit)
- High contrast for text on gradient backgrounds
- Touch targets minimum 44px on mobile
- Loading states clearly indicated for screen readers
